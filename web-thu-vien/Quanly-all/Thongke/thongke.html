<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Th∆∞ vi·ªán Online</title>

    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JavaScript (Popper.js ƒëi k√®m) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet"
        href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Thongke/thongke.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
    <!-- Header -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">

                <!-- Menu ch√≠nh -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 menu">
                    <li class="nav-item">
                        <a class="nav-link" href="https://short.com.vn/VSYd">Qu·∫£n l√Ω ng∆∞·ªùi
                            d√πng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-sach/quanlysach.html">Qu·∫£n
                            l√Ω s√°ch</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-tintuc/quanlytintuc.html">Qu·∫£n
                            l√Ω tin t·ª©c</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-chude/quanlychude.html">Qu·∫£n
                            l√Ω ch·ªß ƒë·ªÅ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Lienhe-hotro/lienhe_hotro.html">Li√™n
                            h·ªá h·ªó tr·ª£</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Thongke/thongke.html">Th·ªëng
                            k√™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/BaoCao/baocao.html">B√°o
                            c√°o</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-chude/logout.php">ƒêƒÉng xu·∫•t</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <main>
        <section id="section-nguoidung" class="container mt-5">
            <h2 class="text-center mb-4 fw-bold" style="color: white;">Th·ªëng k√™ Ng∆∞·ªùi D√πng</h2>

            <!-- H√ÄNG 1: TH·ªêNG K√ä T·ªîNG -->
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card text-white bg-primary mb-4 shadow-lg">
                        <div class="card-body text-center">
                            <h2 id="totalUsers" class="fw-bold">ƒêang t·∫£i...</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- H√ÄNG 2: BI·ªÇU ƒê·ªí & B·∫¢N ƒê·ªí -->
            <div class="row">
                <!-- Bi·ªÉu ƒë·ªì ƒë·ªô tu·ªïi -->
                <div class="col-md-6">
                    <div class="card shadow-lg">
                        <div class="card-body">
                            <h5 class="card-title text-center">Th·ªëng k√™ ƒê·ªô Tu·ªïi</h5>
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- B·∫£n ƒë·ªì ƒë·ªãa ch·ªâ -->
                <div class="col-md-6">
                    <div class="card shadow-lg">
                        <div class="card-body">
                            <h5 class="card-title text-center">Ph√¢n b·ªë ƒê·ªãa Ch·ªâ Ng∆∞·ªùi D√πng</h5>
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="container mt-4" style="margin-bottom: 50px;">
            <h1 class="text-center fw-bold" style="color: white; margin-top: 100px;">Th·ªëng k√™ S√°ch</h1>

            <!-- T·ªïng s·ªë s√°ch -->
            <div class="card text-white bg-primary text-center my-3">
                <div class="card-body">
                    <h4 class="card-title">T·ªïng s·ªë s√°ch: <span id="totalBooks">...</span></h4>
                    <h5 class="card-text">S·ªë l∆∞·ª£t xem trung b√¨nh: <span id="avgViews">...</span></h5>
                </div>
            </div>

            <!-- S√°ch ƒë·∫∑c bi·ªát -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-success text-white text-center my-3">
                        <div class="card-body">
                            <h5 class="card-title">üî• S√°ch ƒê∆∞·ª£c Xem Nhi·ªÅu Nh·∫•t</h5>
                            <p class="card-text" id="mostViewedBook">...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-warning text-dark text-center my-3">
                        <div class="card-body">
                            <h5 class="card-title">üìâ S√°ch √çt ƒê∆∞·ª£c Xem Nh·∫•t</h5>
                            <p class="card-text" id="leastViewedBook">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-info text-white text-center my-3">
                        <div class="card-body">
                            <h5 class="card-title">üìÖ S√°ch M·ªõi Xu·∫•t B·∫£n Nh·∫•t</h5>
                            <p class="card-text" id="newestBook">...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-secondary text-white text-center my-3">
                        <div class="card-body">
                            <h5 class="card-title">üìú S√°ch C≈© Nh·∫•t</h5>
                            <p class="card-text" id="oldestBook">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <!-- Bi·ªÉu ƒë·ªì s·ªë s√°ch xu·∫•t b·∫£n theo nƒÉm -->
                <div class="col-md-6">
                    <div class="card">
                        <h5 class="text-center">üìÖ S·ªë S√°ch Xu·∫•t B·∫£n Theo NƒÉm</h5>
                        <canvas id="booksByYearChart" style="min-height: 500px;"></canvas>
                    </div>
                </div>

                <!-- Bi·ªÉu ƒë·ªì s·ªë s√°ch theo ch·ªß ƒë·ªÅ -->
                <div class="col-md-6">
                    <div class="card">
                        <h5 class="text-center">üìñ S·ªë S√°ch Theo Ch·ªß ƒê·ªÅ</h5>
                        <canvas id="booksByCategoryChart" style="max-height: 500px;"></canvas>
                    </div>
                </div>
            </div>
        </div>


        <script>
            document.addEventListener("DOMContentLoaded", function () {
                fetchUserData();  // G·ªçi th·ªëng k√™ ng∆∞·ªùi d√πng
                fetchBookData();  // G·ªçi th·ªëng k√™ s√°ch
            });

            async function fetchUserData() {
                try {
                    const response = await fetch("thongke_taikhoan.php");
                    const data = await response.json();

                    console.log("D·ªØ li·ªáu th·ªëng k√™ ng∆∞·ªùi d√πng:", data); // Debug

                    if (!data.success) {
                        throw new Error("L·ªói l·∫•y d·ªØ li·ªáu th·ªëng k√™ ng∆∞·ªùi d√πng");
                    }

                    // Hi·ªÉn th·ªã t·ªïng s·ªë ng∆∞·ªùi d√πng
                    const totalUsersElement = document.getElementById("totalUsers");
                    if (totalUsersElement) {
                        totalUsersElement.innerText = `T·ªïng s·ªë ng∆∞·ªùi d√πng: ${data.total_users}`;
                    } else {
                        console.warn("Ph·∫ßn t·ª≠ #totalUsers kh√¥ng t·ªìn t·∫°i trong HTML.");
                    }

                    createAgeChart(data.age_groups);
                    createMap(data.address_counts);

                } catch (error) {
                    console.error("L·ªói khi l·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng:", error);
                }
            }

            async function fetchBookData() {
                try {
                    const response = await fetch("thongke_sach.php");
                    const data = await response.json();

                    console.log("D·ªØ li·ªáu th·ªëng k√™ s√°ch:", data); // Debug

                    if (!data.success) {
                        throw new Error("L·ªói l·∫•y d·ªØ li·ªáu th·ªëng k√™ s√°ch");
                    }

                    // Hi·ªÉn th·ªã t·ªïng s·ªë s√°ch v√† l∆∞·ª£t xem trung b√¨nh
                    document.getElementById("totalBooks").innerText = data.total_books;
                    document.getElementById("avgViews").innerText = data.avg_views;

                    updateBooksByYearChart(data.books_by_year);
                    updateBooksByCategoryChart(data.books_by_category);

                } catch (error) {
                    console.error("L·ªói khi l·∫•y d·ªØ li·ªáu s√°ch:", error);
                }
            }

            function createAgeChart(ageGroups) {
                const ctx = document.getElementById("ageChart");
                if (!ctx) {
                    console.warn("Ph·∫ßn t·ª≠ #ageChart kh√¥ng t·ªìn t·∫°i trong HTML.");
                    return;
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(ageGroups),
                        datasets: [{
                            label: 'S·ªë l∆∞·ª£ng ng∆∞·ªùi',
                            data: Object.values(ageGroups),
                            backgroundColor: ['#2596be', '#e28743', '#abdbe3', '#eab676']
                        }]
                    },
                    options: { responsive: true }
                });
            }

            function createMap(addressCounts) {
                const mapElement = document.getElementById("map");
                if (!mapElement) {
                    console.warn("Ph·∫ßn t·ª≠ #map kh√¥ng t·ªìn t·∫°i trong HTML.");
                    return;
                }

                const locations = {
                    "H·ªì Ch√≠ Minh": [10.7769, 106.7009],
                    "H√† N·ªôi": [21.0285, 105.8542],
                    "B√¨nh D∆∞∆°ng": [10.9804, 106.6519],
                    "C√† Mau": [9.1761, 105.1502],
                    "ƒê·ªìng Nai": [10.9447, 106.8243],
                    "B·∫Øc Giang": [21.2730, 106.1946],
                    "C·∫ßn Th∆°": [10.0452, 105.7469],
                    "Hu·∫ø": [16.4637, 107.5909],
                    "Th√°i B√¨nh": [20.4505, 106.3400],
                    "Ngh·ªá An": [19.2336, 104.9200],
                    "Kon Tum": [14.3498, 108.0000],
                    "H∆∞ng Y√™n": [20.6461, 106.0510],
                    "H·∫£i Ph√≤ng": [20.8449, 106.6881],
                    "Nam ƒê·ªãnh": [20.4388, 106.1621],
                    "Thanh H√≥a": [19.8067, 105.7852],
                    "Qu·∫£ng Nam": [15.5394, 108.0191],
                    "ƒê√† N·∫µng": [16.0544, 108.2022],
                    "Qu·∫£ng Ng√£i": [15.1205, 108.7923],
                    "L√¢m ƒê·ªìng": [11.9404, 108.4583],
                    "Gia Lai": [13.8074, 107.6880],
                    "B√¨nh Thu·∫≠n": [11.0904, 108.2675],
                    "Ph√∫ Y√™n": [13.0882, 109.0929],
                    "Kh√°nh H√≤a": [12.2388, 109.1962]
                };

                let map = L.map('map').setView([15.8700, 107.8100], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                Object.entries(addressCounts).forEach(([address, count]) => {
                    address = address.trim();
                    if (locations[address]) {
                        let marker = L.marker(locations[address]).addTo(map);
                        marker.bindPopup(`<b>${address}</b><br>${count} ng∆∞·ªùi d√πng`);
                    } else {
                        console.warn(`Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô cho: ${address}`);
                    }
                });
            }

            document.addEventListener("DOMContentLoaded", fetchBookData);

            async function fetchBookData() {
                try {
                    // L·∫•y d·ªØ li·ªáu t·ª´ API PHP
                    const response = await fetch("thongke_sach.php");
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error("L·ªói l·∫•y d·ªØ li·ªáu t·ª´ API");
                    }

                    // Hi·ªÉn th·ªã t·ªïng s·ªë s√°ch v√† l∆∞·ª£t xem TB
                    document.getElementById("totalBooks").innerText = data.total_books;
                    document.getElementById("avgViews").innerText = data.avg_views;

                    // Hi·ªÉn th·ªã s√°ch ƒë·∫∑c bi·ªát
                    document.getElementById("mostViewedBook").innerText = `${data.most_viewed_book.ten_sach} (${data.most_viewed_book.so_luot_xem} l∆∞·ª£t xem)`;
                    document.getElementById("leastViewedBook").innerText = `${data.least_viewed_book.ten_sach} (${data.least_viewed_book.so_luot_xem} l∆∞·ª£t xem)`;
                    document.getElementById("newestBook").innerText = `${data.newest_book.ten_sach} (Xu·∫•t b·∫£n: ${data.newest_book.nam_xuat_ban})`;
                    document.getElementById("oldestBook").innerText = `${data.oldest_book.ten_sach} (Xu·∫•t b·∫£n: ${data.oldest_book.nam_xuat_ban})`;

                    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
                    updateBooksByYearChart(data.books_by_year);
                    updateBooksByCategoryChart(data.books_by_category);

                } catch (error) {
                    console.error("L·ªói khi l·∫•y d·ªØ li·ªáu:", error);
                }
            }

            function updateBooksByYearChart(booksByYear) {
                const ctx = document.getElementById("booksByYearChart").getContext("2d");
                new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: Object.keys(booksByYear),
                        datasets: [{
                            label: "S·ªë s√°ch xu·∫•t b·∫£n",
                            data: Object.values(booksByYear),
                            backgroundColor: "rgba(54, 162, 235, 0.7)"
                        }]
                    },
                    options: { responsive: true }
                });
            }

            function updateBooksByCategoryChart(booksByCategory) {
                const ctx = document.getElementById("booksByCategoryChart").getContext("2d");
                new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: Object.keys(booksByCategory),
                        datasets: [{
                            data: Object.values(booksByCategory),
                            backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0"]
                        }]
                    },
                    options: { responsive: true }
                });
            }


        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </main>
</body>

</html>