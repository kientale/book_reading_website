<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Th∆∞ vi·ªán Online</title>

    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JavaScript (Popper.js ƒëi k√®m) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script>

        function resetDisplay() {
            console.log("resetDisplay() ƒë∆∞·ª£c g·ªçi!");
            // X√≥a n·ªôi dung √¥ t√¨m ki·∫øm
            document.getElementById("searchInput").value = "";
            // ƒê∆∞a b·ªô l·ªçc v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh
            document.getElementById("filterType").selectedIndex = 0;
            // X√≥a d·ªØ li·ªáu hi·ªán t·∫°i trong b·∫£ng
            const bookTableBody = document.getElementById("bookTableBody");
            bookTableBody.innerHTML = "";
            // G·ªçi h√†m fetchBookData ƒë·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu s√°ch
            fetchBooks();
        }

        // Hi·ªÉn th·ªã th√¥ng tin v√†o b·∫£ng
        document.addEventListener("DOMContentLoaded", function () {
            fetchBooks();
        });

        function fetchBooks() {
            fetch("quanlysach.php")
                .then(response => response.json())
                .then(books => {
                    const bookTableBody = document.getElementById("bookTableBody");
                    bookTableBody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

                    if (!Array.isArray(books)) {
                        console.error("L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá", books);
                        bookTableBody.innerHTML = "<tr><td colspan='10'>L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>";
                        return;
                    }

                    books.forEach(book => {
                        const row = document.createElement("tr");

                        row.innerHTML = `
                    <td>${book.id_sach}</td>
                    <td>${book.ten_sach}</td>
                    <td>${book.tac_gia}</td>
                    <td>${book.nam_xuat_ban}</td>
                    <td>${book.so_luong}</td>
                    <td>${book.so_luot_xem}</td>
                    <td>${book.id_chu_de}</td>
                    <td><img src="${book.hinh_anh}" alt="·∫¢nh s√°ch" width="50"></td>
                    <td>${book.mo_ta_sach}</td>
                    <td style="background: #76b5c5">
                        <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" 
                            data-bs-target="#editBookModal" onclick="setEditBook(${book.id_sach})">
                            S·ª≠a
                        </button>
                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
        data-bs-target="#deleteBookModal"
        onclick="setDeleteBook(this.getAttribute('data-id'))"
        data-id="${book.id_sach}">
    X√≥a
</button>

                    </td>
                `;

                        bookTableBody.appendChild(row);
                    });

                    console.log("ƒê√£ t·∫£i xong danh s√°ch s√°ch.");
                })
                .catch(error => {
                    console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
                    document.getElementById("bookTableBody").innerHTML = "<tr><td colspan='10'>L·ªói k·∫øt n·ªëi ƒë·∫øn server.</td></tr>";
                });
        }


        // L·∫•y ch·ªß ƒë·ªÅ
        document.addEventListener("DOMContentLoaded", () => {
            // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch ch·ªß ƒë·ªÅ
            fetch("get_chude.php")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data); // Debug

                    // L·∫•y t·∫•t c·∫£ c√°c select li√™n quan ƒë·∫øn ch·ªß ƒë·ªÅ
                    let selectElements = document.querySelectorAll("#idChuDe, #editIdChuDe");

                    selectElements.forEach(selectChuDe => {
                        if (!Array.isArray(data)) {
                            console.error("L·ªói: API kh√¥ng tr·∫£ v·ªÅ m·∫£ng JSON h·ª£p l·ªá!");
                            selectChuDe.innerHTML = `<option value="">D·ªØ li·ªáu l·ªói</option>`;
                            return;
                        }

                        if (data.length === 0) {
                            selectChuDe.innerHTML = `<option value="">Kh√¥ng c√≥ ch·ªß ƒë·ªÅ</option>`;
                            return;
                        }

                        // C·∫•u h√¨nh c√°c option cho select
                        selectChuDe.innerHTML = `<option value="">Ch·ªçn ch·ªß ƒë·ªÅ</option>`;
                        data.forEach(chuDe => {
                            let option = document.createElement("option");
                            option.value = chuDe.id_chu_de;
                            option.textContent = chuDe.ten_chu_de;
                            selectChuDe.appendChild(option);
                        });
                    });
                })
                .catch(error => {
                    console.error("L·ªói khi t·∫£i ch·ªß ƒë·ªÅ:", error);
                    // N·∫øu l·ªói, hi·ªÉn th·ªã th√¥ng b√°o tr√™n c·∫£ hai select
                    document.querySelectorAll("#idChuDe, #editIdChuDe").forEach(selectChuDe => {
                        selectChuDe.innerHTML = `<option value="">Kh√¥ng th·ªÉ t·∫£i ch·ªß ƒë·ªÅ</option>`;
                    });
                });
        });


        // X√≥a d·ªØ li·ªáu trong c√°c tr∆∞·ªùng
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Loaded, initializing event listeners for book modals...");

            // H√†m reset c√°c tr∆∞·ªùng trong form c·ªßa m·ªôt modal c·ª• th·ªÉ
            function resetFormFields(modalId, fieldIds) {
                console.log(`Resetting form fields for modal: ${modalId}`);
                fieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.tagName === "SELECT") {
                            el.selectedIndex = 0; // Reset dropdown v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
                        } else {
                            el.value = "";
                        }
                    } else {
                        console.warn(`Kh√¥ng t√¨m th·∫•y element v·ªõi id "${id}"`);
                    }
                });
            }

            // H√†m thi·∫øt l·∫≠p s·ª± ki·ªán cho m·ªôt modal c·ª• th·ªÉ
            function setupModalEventHandlers(modalId, fieldIds, clearBtnId) {
                // G√°n s·ª± ki·ªán cho n√∫t "X√≥a th√¥ng tin" trong modal
                const clearBtn = document.getElementById(clearBtnId);
                if (clearBtn) {
                    console.log(`Found '${clearBtnId}' button, adding event listener...`);
                    clearBtn.addEventListener("click", () => {
                        console.log(`Clear button clicked for modal: ${modalId}`);
                        resetFormFields(modalId, fieldIds);
                    });
                } else {
                    console.error(`Kh√¥ng t√¨m th·∫•y n√∫t '${clearBtnId}'. Ki·ªÉm tra l·∫°i HTML.`);
                }

                // Reset form khi modal b·ªã ƒë√≥ng
                const modalEl = document.getElementById(modalId);
                if (modalEl) {
                    modalEl.addEventListener("hidden.bs.modal", () => {
                        console.log(`Modal hidden event triggered for: ${modalId}`);
                        resetFormFields(modalId, fieldIds);
                    });
                } else {
                    console.error(`Kh√¥ng t√¨m th·∫•y modal v·ªõi id '${modalId}'.`);
                }
            }

            // C·∫•u h√¨nh cho c√°c modal li√™n quan ƒë·∫øn s√°ch
            const bookModalConfigs = [
                {
                    modalId: "bookModal",
                    fieldIds: ["idSach", "tenSach", "tacGia", "namXuatBan", "soLuong", "idChuDe", "hinhAnh", "moTaSach"],
                    clearBtnId: "clearBook"
                },
                {
                    modalId: "searchBookModal",
                    fieldIds: ["searchMaSach"],
                    clearBtnId: "clearSearchButton"
                }
            ];

            // Kh·ªüi t·∫°o s·ª± ki·ªán cho t·ª´ng modal
            bookModalConfigs.forEach(config => {
                setupModalEventHandlers(config.modalId, config.fieldIds, config.clearBtnId);
            });
        });




        //Th√™m s√°ch
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("saveBook").addEventListener("click", async () => {
                const formData = new FormData();
                formData.append("idSach", document.getElementById("idSach").value.trim());
                formData.append("tenSach", document.getElementById("tenSach").value.trim());
                formData.append("tacGia", document.getElementById("tacGia").value.trim());
                formData.append("namXuatBan", document.getElementById("namXuatBan").value.trim());
                formData.append("soLuong", document.getElementById("soLuong").value.trim());
                formData.append("idChuDe", document.getElementById("idChuDe").value.trim());
                formData.append("moTaSach", document.getElementById("moTaSach").value.trim());
                formData.append("hinhAnh", document.getElementById("hinhAnh").files[0]);

                console.log("D·ªØ li·ªáu FormData g·ª≠i l√™n:", Array.from(formData.entries())); // Debug

                try {
                    const response = await fetch("themsach.php", {
                        method: "POST",
                        body: formData,
                    });
                    const data = await response.json();
                    console.log("K·∫øt qu·∫£ t·ª´ server:", data); // Debug
                    if (data.success) {
                        alert("Th√™m s√°ch th√†nh c√¥ng!");
                        location.reload();
                    } else {
                        alert("L·ªói: " + data.error);
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ª≠i d·ªØ li·ªáu:", error);
                }
            });
        });



        /*S·ª¨a s√°ch*/
        function setEditBook(idSach) {
            fetch("quanlysach.php")
                .then(response => response.json())
                .then(books => {
                    console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", books); // Ki·ªÉm tra d·ªØ li·ªáu trong Console

                    const book = books.find(book => book.id_sach == idSach);
                    if (!book) {
                        console.error("Kh√¥ng t√¨m th·∫•y s√°ch v·ªõi ID:", idSach);
                        return;
                    }

                    // ƒêi·ªÅn th√¥ng tin s√°ch v√†o modal
                    document.getElementById("editIdSach").value = book.id_sach;
                    document.getElementById("editTenSach").value = book.ten_sach;
                    document.getElementById("editTacGia").value = book.tac_gia;
                    document.getElementById("editNamXuatBan").value = book.nam_xuat_ban;
                    document.getElementById("editSoLuong").value = book.so_luong;
                    document.getElementById("editSoLuotXem").value = book.so_luot_xem;
                    document.getElementById("editIdChuDe").value = book.id_chu_de;
                    document.getElementById("editMoTaSach").value = book.mo_ta_sach;

                    // X·ª≠ l√Ω h√¨nh ·∫£nh
                    const previewImage = document.getElementById("previewHinhAnh");
                    if (book.hinh_anh) {
                        if (book.hinh_anh.startsWith("http") || book.hinh_anh.startsWith("/")) {
                            previewImage.src = book.hinh_anh; // N·∫øu l√† ƒë∆∞·ªùng d·∫´n
                        } else {
                            previewImage.src = book.hinh_anh; // N·∫øu l√† Base64
                        }
                        previewImage.style.display = "block";
                    } else {
                        previewImage.style.display = "none";
                    }
                })
                .catch(error => console.error("L·ªói khi t·∫£i d·ªØ li·ªáu s√°ch:", error));
        }

        document.addEventListener("DOMContentLoaded", function () {
            function resetEditBookForm() {
                document.getElementById("editBookForm")?.reset();
                document.getElementById("previewHinhAnh").style.display = "none";
            }

            document.getElementById("clearEditBook")?.addEventListener("click", resetEditBookForm);
            document.getElementById("editBookModal")?.addEventListener("hidden.bs.modal", resetEditBookForm);

            document.getElementById("saveEditBook")?.addEventListener("click", function (event) {
                event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh

                const formData = new FormData();
                formData.append("idSach", document.getElementById("editIdSach").value.trim());
                formData.append("tenSach", document.getElementById("editTenSach").value.trim());
                formData.append("tacGia", document.getElementById("editTacGia").value.trim());
                formData.append("namXuatBan", document.getElementById("editNamXuatBan").value.trim());
                formData.append("soLuong", document.getElementById("editSoLuong").value.trim());
                formData.append("soLuotXem", document.getElementById("editSoLuotXem").value.trim());
                formData.append("idChuDe", document.getElementById("editIdChuDe").value.trim());
                formData.append("moTaSach", document.getElementById("editMoTaSach").value.trim());

                const hinhAnhFile = document.getElementById("editHinhAnhFile").files[0];

                if (hinhAnhFile) {
                    console.log("üñº ƒêang g·ª≠i file ·∫£nh:", hinhAnhFile.name); // Ki·ªÉm tra file c√≥ ƒë∆∞·ª£c g·ª≠i kh√¥ng
                    formData.append("hinhAnh", hinhAnhFile);
                } else {
                    console.log("‚ö† Kh√¥ng c√≥ file ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn!");
                }

                fetch("suasach.php", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.text()) // ƒê·ªçc th√¥ ph·∫£n h·ªìi
                    .then(text => {
                        console.log("üîç Server Response:", text); // Log k·∫øt qu·∫£ nh·∫≠n ƒë∆∞·ª£c
                        try {
                            return JSON.parse(text); // Chuy·ªÉn th√†nh JSON
                        } catch (error) {
                            throw new Error("‚ùå Server kh√¥ng tr·∫£ v·ªÅ JSON h·ª£p l·ªá!");
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            alert("‚úÖ C·∫≠p nh·∫≠t s√°ch th√†nh c√¥ng!");
                            location.reload();
                        } else {
                            alert("‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + (data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh!"));
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        alert("‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn server ho·∫∑c l·ªói JSON!");
                    });
            });

        });



        /* X√≥a s√°ch */
        document.addEventListener("DOMContentLoaded", function () {
            function setDeleteBook(idSach) {
                console.log("S√°ch c·∫ßn x√≥a:", idSach);

                // Ki·ªÉm tra input ·∫©n l∆∞u ID s√°ch
                const deleteInput = document.getElementById("deleteIdSach");
                if (deleteInput) {
                    deleteInput.value = idSach;
                } else {
                    console.error("Kh√¥ng t√¨m th·∫•y input ·∫©n #deleteIdSach.");
                }
            }

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n "X√°c nh·∫≠n x√≥a"
            document.getElementById("confirmDeleteBook").addEventListener("click", function () {
                const deleteInput = document.getElementById("deleteIdSach");
                const idSach = deleteInput ? deleteInput.value.trim() : "";

                if (!idSach) {
                    alert("L·ªói: Kh√¥ng t√¨m th·∫•y m√£ s√°ch c·∫ßn x√≥a!");
                    return;
                }

                if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch n√†y?")) {
                    return;
                }

                fetch("xoasach.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ maSach: idSach }) // ƒê·ªïi t·ª´ idSach th√†nh maSach
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("X√≥a s√°ch th√†nh c√¥ng!");
                            location.reload();
                        } else {
                            alert("L·ªói: " + data.error);
                        }
                    })
                    .catch(error => console.error("L·ªói khi x√≥a s√°ch:", error));
            });

            // ƒê∆∞a setDeleteBook v√†o ph·∫°m vi to√†n c·ª•c ƒë·ªÉ g·ªçi t·ª´ HTML
            window.setDeleteBook = setDeleteBook;
        });




        // T√¨m ki·∫øm s√°ch
        document.addEventListener("DOMContentLoaded", function () {
            const searchBookButton = document.getElementById("searchBookButton");
            const clearSearchButton = document.getElementById("clearSearchButton");
            const searchInput = document.getElementById("searchMaSach");
            const searchResult = document.getElementById("searchResult");

            // S·ª± ki·ªán cho n√∫t T√¨m ki·∫øm
            searchBookButton.addEventListener("click", function () {
                const maSach = searchInput.value.trim();

                if (!maSach) {
                    alert("Vui l√≤ng nh·∫≠p m√£ s√°ch!");
                    return;
                }

                fetch("timkiemsach.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id_sach: maSach }) // C·∫≠p nh·∫≠t t√™n bi·∫øn theo b·∫£ng CSDL m·ªõi
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success || !data.book) {
                            searchResult.innerHTML = `<p class="text-danger">${data.error || "Kh√¥ng t√¨m th·∫•y s√°ch!"}</p>`;
                        } else {
                            const book = data.book;
                            searchResult.innerHTML = `
                        <table class="table table-bordered mt-3">
                            <tr><th>M√£ S√°ch</th><td>${book.id_sach || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                            <tr><th>T√™n S√°ch</th><td>${book.ten_sach || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                            <tr><th>T√°c Gi·∫£</th><td>${book.tac_gia || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                            <tr><th>NƒÉm Xu·∫•t B·∫£n</th><td>${book.nam_xuat_ban || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                            <tr><th>S·ªë L∆∞·ª£ng</th><td>${book.so_luong || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                            <tr><th>S·ªë L∆∞·ª£t Xem</th><td>${book.so_luot_xem || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                            <tr><th>Id Ch·ªß ƒê·ªÅ</th><td>${book.id_chu_de || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                            <tr><th>H√¨nh ·∫¢nh</th>
                                <td>
                                    ${book.hinh_anh
                                    ? `<img src="${book.hinh_anh}" alt="H√¨nh ·∫£nh s√°ch" width="100">`
                                    : "Kh√¥ng c√≥ d·ªØ li·ªáu"}
                                </td>
                            </tr>
                            <tr><th>M√¥ T·∫£ S√°ch</th><td>${book.mo_ta_sach || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
                        </table>
                    `;
                        }
                    })
                    .catch(error => console.error("L·ªói khi t√¨m ki·∫øm s√°ch:", error));
            });

            // S·ª± ki·ªán cho n√∫t X√≥a th√¥ng tin (Clear)
            clearSearchButton.addEventListener("click", function () {
                searchInput.value = "";
                searchResult.innerHTML = "";
                console.log("Th√¥ng tin t√¨m ki·∫øm ƒë√£ ƒë∆∞·ª£c x√≥a.");
            });
        });



        function fetchFilteredBooks() {
            const keyword = document.getElementById("searchInput").value.trim();
            const filterType = document.getElementById("filterType").value;
            const bookTableBody = document.getElementById("bookTableBody");

            fetch("locsach.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ keyword, filterType })
            })
                .then(response => response.json())
                .then(data => {
                    bookTableBody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

                    if (!data.success || !Array.isArray(data.books)) {
                        bookTableBody.innerHTML = "<tr><td colspan='10'>L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>";
                        console.error("L·ªói t·ª´ server:", data.error || "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!");
                        return;
                    }

                    const books = data.books;
                    if (books.length === 0) {
                        bookTableBody.innerHTML = "<tr><td colspan='10'>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</td></tr>";
                        return;
                    }

                    let rowsHTML = "";
                    books.forEach(book => {
                        const formattedPrice = new Intl.NumberFormat("vi-VN").format(book.gia || 0) + " VND";
                        const imageHTML = book.hinh_anh
                            ? `<img src="${book.hinh_anh}" alt="·∫¢nh s√°ch" width="50">`
                            : "Kh√¥ng c√≥ ·∫£nh";
                        const description = book.mo_ta_sach ? book.mo_ta_sach : "Kh√¥ng c√≥ m√¥ t·∫£";

                        rowsHTML += `
                    <tr>
                        <td>${book.id_sach}</td>
                        <td>${book.ten_sach}</td>
                        <td>${book.tac_gia}</td>
                        <td>${book.nam_xuat_ban}</td>
                        <td>${book.so_luong}</td>
                        <td>${book.so_luot_xem}</td>
                        <td>${book.id_chu_de}</td>
                        <td>${imageHTML}</td>
                        <td>${description}</td>
                        <td style="background: #76b5c5">
                            <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" 
                                data-bs-target="#editBookModal" onclick="setEditBook(${book.id_sach})">
                                S·ª≠a
                            </button>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                data-bs-target="#deleteBookModal"
                                onclick="setDeleteBook(${book.id_sach})">
                                X√≥a
                            </button>
                        </td>
                    </tr>
                `;
                    });

                    bookTableBody.innerHTML = rowsHTML;
                })
                .catch(error => {
                    bookTableBody.innerHTML = "<tr><td colspan='10'>L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>";
                    console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
                });
        }


        document.addEventListener("DOMContentLoaded", function () {
            const searchForm = document.getElementById("searchForm");
            if (searchForm) {
                searchForm.addEventListener("submit", function (event) {
                    event.preventDefault(); // NgƒÉn reload trang
                    fetchFilteredBooks();
                });
            }
        });


        //COde xu·∫•t Excel
        async function exportToExcel() {
            let fileName = prompt("Nh·∫≠p t√™n file (kh√¥ng c·∫ßn .xlsx):", "Book_List");
            if (!fileName) return;

            let table = document.querySelector("table");
            let workbook = new ExcelJS.Workbook();
            let worksheet = workbook.addWorksheet("Books");

            let rows = table.querySelectorAll("tr");

            for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
                let row = rows[rowIndex];
                let rowData = [];
                let cells = row.querySelectorAll("th, td");

                for (let colIndex = 0; colIndex < cells.length - 1; colIndex++) { // Lo·∫°i b·ªè c·ªôt cu·ªëi (H√†nh ƒë·ªông)
                    let cell = cells[colIndex];
                    let imgTag = cell.querySelector("img");

                    if (imgTag) {
                        try {
                            let base64 = await getBase64Image(imgTag);
                            let imageId = workbook.addImage({
                                base64: base64,
                                extension: "png",
                            });

                            worksheet.addImage(imageId, {
                                tl: { col: colIndex, row: rowIndex },
                                ext: { width: 50, height: 50 },
                            });

                            rowData.push(""); // Gi·ªØ ch·ªó cho ·∫£nh
                        } catch (error) {
                            console.error("L·ªói khi t·∫£i ·∫£nh:", error);
                        }
                    } else {
                        rowData.push(cell.innerText);
                    }
                }

                worksheet.addRow(rowData);
            }

            // Xu·∫•t file Excel
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], {
                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            });

            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: `${fileName}.xlsx`,
                        types: [{ description: "Excel File", accept: { "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"] } }],
                    });

                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    alert("Xu·∫•t file th√†nh c√¥ng!");
                    return;
                } catch (err) {
                    console.error("L·ªói khi l∆∞u file:", err);
                }
            }

            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${fileName}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Chuy·ªÉn ·∫£nh th√†nh Base64
        function getBase64Image(img) {
            return new Promise((resolve, reject) => {
                let canvas = document.createElement("canvas");
                let ctx = canvas.getContext("2d");
                let imgElement = new Image();
                imgElement.crossOrigin = "Anonymous";
                imgElement.src = img.src;

                imgElement.onload = function () {
                    canvas.width = imgElement.naturalWidth;
                    canvas.height = imgElement.naturalHeight;
                    ctx.drawImage(imgElement, 0, 0);
                    let dataURL = canvas.toDataURL("image/png").split(",")[1];
                    resolve(dataURL);
                };

                imgElement.onerror = function () {
                    reject("Kh√¥ng th·ªÉ t·∫£i ·∫£nh.");
                };
            });
        }


    </script>
</head>

<body>
    <!-- Header -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">

                <!-- Menu ch√≠nh -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 menu">
                    <li class="nav-item">
                        <a class="nav-link" href="https://short.com.vn/VSYd">Qu·∫£n l√Ω ng∆∞·ªùi
                            d√πng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-sach/quanlysach.html">Qu·∫£n
                            l√Ω s√°ch</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-tintuc/quanlytintuc.html">Qu·∫£n
                            l√Ω tin t·ª©c</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-chude/quanlychude.html">Qu·∫£n
                            l√Ω ch·ªß ƒë·ªÅ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Lienhe-hotro/lienhe_hotro.html">Li√™n
                            h·ªá h·ªó tr·ª£</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Thongke/thongke.html">Th·ªëng
                            k√™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/BaoCao/baocao.html">B√°o
                            c√°o</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-chude/logout.php">ƒêƒÉng
                            xu·∫•t</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <style>
            body {
                background-color: #873e23;
                /* M√†u n·ªÅn mong mu·ªën */
            }

            .table {
                background-color: white !important;
                /* Gi·ªØ m√†u tr·∫Øng cho b·∫£ng */
            }
        </style>
        <div class="container mt-5" style="max-width: 2200px !important;">
            <div class="container mt-4" style="margin-bottom: -10px;">
                <!-- C√°c n√∫t ch·ª©c nƒÉng -->
                <div class="mb-3 d-flex justify-content-start">
                    <h2 class="text-center" style="margin-right: 100px; color: white;">Qu·∫£n l√Ω s√°ch</h2>
                    <button class="btn btn-primary me-2" data-bs-toggle="modal"
                        data-bs-target="#bookModal">Th√™m</button>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#searchBookModal">T√¨m
                        ki·∫øm</button>
                    <button class="btn btn-warning me-2" type="button" onclick="resetDisplay()">Reset</button>

                    <!-- Giao di·ªán -->
                    <form id="searchForm" class="d-flex search-form">
                        <select class="form-select me-2" id="filterType">
                            <option value="ten_sach">L·ªçc theo t√™n s√°ch</option>
                            <option value="tac_gia">L·ªçc theo t√°c gi·∫£</option>
                            <option value="nam_xuat_ban">L·ªçc theo nƒÉm xu·∫•t b·∫£n</option>
                            <option value="id_chu_de">L·ªçc theo ch·ªß ƒë·ªÅ</option>
                        </select>
                        <input id="searchInput" class="form-control me-2" type="text" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
                        <button id="searchButton" class="btn btn-danger me-2" type="submit">L·ªçc</button>
                    </form>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
                    <button class="btn btn-info me-2" onclick="exportToExcel()">üì§ Xu·∫•t Excel</button>
                    <button class="btn btn-secondary me-2" onclick="importExcel()">üì• Nh·∫≠p Excel</button>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;"
                        onchange="handleFile(event)">
                </div>
            </div>
            <table class="table table-bordered table-hover">
                <!-- B·∫£ng hi·ªÉn th·ªã k·∫øt qu·∫£ -->
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>T√™n s√°ch</th>
                        <th>T√°c gi·∫£</th>
                        <th>NƒÉm xu·∫•t b·∫£n</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>S·ªë l∆∞·ª£t xem</th>
                        <th>ID ch·ªß ƒë·ªÅ</th>
                        <th>H√¨nh ·∫£nh</th>
                        <th>M√¥ t·∫£</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="bookTableBody">
                    <tr>
                        <td colspan="9">Nh·∫≠p t·ª´ kh√≥a v√† nh·∫•n "L·ªçc" ƒë·ªÉ t√¨m ki·∫øm.</td>
                    </tr>
                </tbody>
            </table>
        </div>


        <!-- Bootstrap Modal Th√™m S√°ch -->
        <div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bookModalLabel">Th√™m S√°ch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Form nh·∫≠p th√¥ng tin s√°ch -->
                        <form id="bookForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="idSach" class="form-label">ID S√°ch:</label>
                                <input type="number" id="idSach" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="tenSach" class="form-label">T√™n s√°ch:</label>
                                <input type="text" id="tenSach" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="tacGia" class="form-label">T√°c gi·∫£:</label>
                                <input type="text" id="tacGia" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="namXuatBan" class="form-label">NƒÉm xu·∫•t b·∫£n:</label>
                                <input type="number" id="namXuatBan" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="soLuong" class="form-label">S·ªë l∆∞·ª£ng:</label>
                                <input type="number" id="soLuong" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="soLuotXem" class="form-label">S·ªë l∆∞·ª£t xem:</label>
                                <input type="number" id="soLuotXem" class="form-control" value="0" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="idChuDe" class="form-label">Ch·ªß ƒë·ªÅ:</label>
                                <select id="idChuDe" class="form-control" required>
                                    <option value="">ƒêang t·∫£i ch·ªß ƒë·ªÅ...</option>
                                </select>
                            </div>
                            <!-- Th√™m ·∫£nh -->
                            <div class="mb-3">
                                <label for="hinhAnh" class="form-label">H√¨nh ·∫£nh:</label>
                                <input type="file" id="hinhAnh" class="form-control" accept="image/*" required>
                                <img id="previewImage" src="#" alt="Xem tr∆∞·ªõc ·∫£nh"
                                    style="display:none; margin-top:10px; max-width: 100%; height: auto;">
                            </div>
                            <div class="mb-3">
                                <label for="moTaSach" class="form-label">M√¥ t·∫£ s√°ch:</label>
                                <textarea id="moTaSach" class="form-control" rows="3" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-warning" id="clearBook">X√≥a th√¥ng tin</button>
                        <button type="button" class="btn btn-success" id="saveBook">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            // Xem tr∆∞·ªõc ·∫£nh khi ch·ªçn file
            document.getElementById('hinhAnh').addEventListener('change', function (event) {
                let reader = new FileReader();
                reader.onload = function () {
                    let preview = document.getElementById('previewImage');
                    preview.src = reader.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(event.target.files[0]);
            });
        </script>


        <!-- Bootstrap Modal S·ª≠a S√°ch -->
        <div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editBookModalLabel">S·ª≠a S√°ch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Form ch·ªânh s·ª≠a th√¥ng tin s√°ch -->
                        <div class="mb-3">
                            <label for="editIdSach" class="form-label">ID S√°ch:</label>
                            <input type="number" id="editIdSach" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editTenSach" class="form-label">T√™n S√°ch:</label>
                            <input type="text" id="editTenSach" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTacGia" class="form-label">T√°c Gi·∫£:</label>
                            <input type="text" id="editTacGia" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editNamXuatBan" class="form-label">NƒÉm Xu·∫•t B·∫£n:</label>
                            <input type="number" id="editNamXuatBan" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSoLuong" class="form-label">S·ªë L∆∞·ª£ng:</label>
                            <input type="number" id="editSoLuong" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSoLuotXem" class="form-label">S·ªë L∆∞·ª£t Xem:</label>
                            <input type="number" id="editSoLuotXem" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editIdChuDe" class="form-label">Ch·ªß ƒë·ªÅ:</label>
                            <select id="editIdChuDe" class="form-control" required>
                                <option value="">ƒêang t·∫£i ch·ªß ƒë·ªÅ...</option>
                            </select>
                        </div>

                        <!-- Hi·ªÉn th·ªã ·∫£nh t·ª´ BLOB -->
                        <div class="mb-3">
                            <label class="form-label">H√¨nh ·∫£nh hi·ªán t·∫°i:</label>
                            <img id="previewHinhAnh" src="" class="img-thumbnail d-block" style="max-width: 200px;">
                        </div>

                        <!-- T·∫£i ·∫£nh m·ªõi -->
                        <div class="mb-3">
                            <label for="editHinhAnhFile" class="form-label">Ch·ªçn ·∫£nh m·ªõi:</label>
                            <input type="file" id="editHinhAnhFile" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label for="editMoTaSach" class="form-label">M√¥ t·∫£ s√°ch:</label>
                            <textarea id="editMoTaSach" class="form-control" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-warning" id="clearEditBook">X√≥a th√¥ng tin</button>
                        <button type="button" class="btn btn-primary" id="saveEditBook">L∆∞u thay ƒë·ªïi</button>
                    </div>
                </div>
            </div>
        </div>


        <!--Modal x√≥a s√°ch-->
        <div id="deleteBookModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">X√°c nh·∫≠n x√≥a s√°ch</h5>
                    </div>
                    <div class="modal-body">
                        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch n√†y kh√¥ng?
                        <input type="hidden" id="deleteIdSach">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBook">X√°c nh·∫≠n x√≥a</button>
                    </div>
                </div>
            </div>
        </div>

        <!--Modal t√¨m ki·∫øm s√°ch-->
        <div class="modal fade" id="searchBookModal" tabindex="-1" aria-labelledby="searchBookModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="searchBookModalLabel">T√¨m Ki·∫øm S√°ch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="searchMaSach" class="form-label">Nh·∫≠p M√£ S√°ch:</label>
                            <input type="text" id="searchMaSach" class="form-control">
                        </div>
                        <!-- N√∫t H·ªßy ƒë√≥ng modal -->
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <!-- N√∫t X√≥a th√¥ng tin ƒë·ªÉ reset tr∆∞·ªùng nh·∫≠p -->
                        <button type="button" class="btn btn-warning" id="clearSearchButton">X√≥a th√¥ng tin</button>
                        <button type="button" class="btn btn-primary" id="searchBookButton">T√¨m Ki·∫øm</button>
                        <hr>
                        <div id="searchResult"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</body>

</html>