<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Th∆∞ vi·ªán Online</title>

    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script>

        // H√†m th·ª±c hi·ªán g·ªçi AJAX ƒë·∫øn loc.php
        function fetchFilteredUsers() {
            console.log("fetchFilteredUsers() ƒë∆∞·ª£c g·ªçi!");

            const keyword = document.getElementById("searchInput").value.trim();
            const filterType = document.getElementById("filterType").value;
            const userTableBody = document.getElementById("userTableBody");

            fetch("loc.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ keyword, filterType })
            })
                .then(response => response.json())
                .then(users => {
                    console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", users);
                    userTableBody.innerHTML = ""; // X√≥a n·ªôi dung c≈©

                    if (!Array.isArray(users)) {
                        userTableBody.innerHTML = "<tr><td colspan='8'>L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>";
                        console.error("L·ªói: D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng ph·∫£i m·∫£ng", users);
                        return;
                    }
                    if (users.length === 0) {
                        userTableBody.innerHTML = "<tr><td colspan='8'>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</td></tr>";
                    } else {
                        users.forEach(user => {
                            const row = `<tr>
            <td>${user.ma_nguoi_dung}</td>
            <td>${user.tai_khoan}</td>
            <td>${user.mat_khau}</td>
            <td>${user.ho_ten}</td>
            <td>${user.tuoi}</td>
            <td>${user.email}</td>
            <td>${user.so_dien_thoai}</td>
            <td>${user.dia_chi}</td>
            <td style="background: #76b5c5">
                        <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" 
                            data-bs-target="#editUserModal" onclick="setEditUser(${user.ma_nguoi_dung})">
                            S·ª≠a
                        </button>
                       <button class="btn btn-danger btn-sm" 
        data-bs-toggle="modal" 
        data-bs-target="#deleteUserModal" 
        onclick="setDeleteUser('${user.ma_nguoi_dung}')" style="margin-right: 5px;">
    X√≥a
</button>
                    </td>
          </tr>`;
                            userTableBody.innerHTML += row;
                        });
                    }
                })
                .catch(error => {
                    userTableBody.innerHTML = "<tr><td colspan='8'>L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>";
                    console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
                });
        }

        function resetDisplay() {
            console.log("resetDisplay() ƒë∆∞·ª£c g·ªçi!");
            // X√≥a n·ªôi dung √¥ t√¨m ki·∫øm
            document.getElementById("searchInput").value = "";
            // ƒê∆∞a b·ªô l·ªçc v·ªÅ gi√° tr·ªã ƒë·∫ßu ti√™n
            document.getElementById("filterType").selectedIndex = 0;
            // G·ªçi h√†m fetchUserData ƒë·ªÉ t·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu ng∆∞·ªùi d√πng v√† hi·ªÉn th·ªã l√™n b·∫£ng
            const userTableBody = document.getElementById("userTableBody");
            fetchUserData(userTableBody);
        }

        window.onload = function () {
            console.log("Trang ƒë√£ t·∫£i xong!");

            // Ki·ªÉm tra userTableBody sau khi trang t·∫£i ho√†n to√†n
            let userTableBody = document.getElementById("userTableBody");

            if (!userTableBody) {
                console.warn("Ch∆∞a t√¨m th·∫•y ph·∫ßn t·ª≠ userTableBody, th·ª≠ l·∫°i sau...");

                // ƒê·ª£i 1 gi√¢y r·ªìi ki·ªÉm tra l·∫°i
                setTimeout(() => {
                    userTableBody = document.getElementById("userTableBody");
                    console.log("Ki·ªÉm tra l·∫°i sau 1 gi√¢y:", userTableBody);
                    if (!userTableBody) {
                        console.error("V·∫´n kh√¥ng t√¨m th·∫•y userTableBody! Ki·ªÉm tra l·∫°i ID trong HTML.");
                        return;
                    }
                    fetchUserData(userTableBody);
                }, 1000);
            } else {
                fetchUserData(userTableBody);
            }
        };


        // H√†m reset to√†n b·ªô tr∆∞·ªùng trong form
        function resetUserForm() {
            console.log("Resetting form fields...");
            const fieldIds = [
                "maNguoiDung", "taiKhoan", "matKhau",
                "hoTen", "tuoi", "email", "soDienThoai", "diaChi"
            ];
            fieldIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = "";
                } else {
                    console.warn(`Kh√¥ng t√¨m th·∫•y element v·ªõi id "${id}"`);
                }
            });
        }

        // H√†m kh·ªüi t·∫°o c√°c event handler cho vi·ªác reset form
        function initResetHandlers() {
            // G√°n s·ª± ki·ªán cho n√∫t "X√≥a th√¥ng tin"
            const clearBtn = document.getElementById("clearBtn");
            if (clearBtn) {
                clearBtn.addEventListener("click", function () {
                    console.log("Clear button clicked.");
                    resetUserForm();
                });
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y n√∫t 'clearBtn'. Vui l√≤ng ki·ªÉm tra l·∫°i ID trong HTML.");
            }

            // Khi modal b·ªã ·∫©n, reset l·∫°i form
            const userModalEl = document.getElementById("userModal");
            if (userModalEl) {
                userModalEl.addEventListener('hidden.bs.modal', function () {
                    console.log("Modal hidden event triggered.");
                    resetUserForm();
                });
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y modal v·ªõi id 'userModal'.");
            }
        }

        // Cho ph√©p c√°c n√∫t kh√°c s·ª≠ d·ª•ng c√°c h√†m n√†y
        window.resetUserForm = resetUserForm;
        window.initResetHandlers = initResetHandlers;

        // Kh·ªüi t·∫°o c√°c event handler khi DOM ƒë√£ ƒë∆∞·ª£c load
        document.addEventListener("DOMContentLoaded", function () {
            initResetHandlers();
        });

        /*Th√™m ng∆∞·ªùi d√πng*/
        document.addEventListener("DOMContentLoaded", () => {
            // H√†m reset to√†n b·ªô tr∆∞·ªùng trong form
            function resetUserForm() {
                console.log("Resetting form fields...");
                const fieldIds = [
                    "maNguoiDung",
                    "taiKhoan",
                    "matKhau",
                    "hoTen",
                    "tuoi",
                    "email",
                    "soDienThoai",
                    "diaChi"
                ];
                fieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = "";
                    } else {
                        console.warn(`Kh√¥ng t√¨m th·∫•y element v·ªõi id "${id}"`);
                    }
                });
            }

            // H√†m kh·ªüi t·∫°o c√°c s·ª± ki·ªán reset form: n√∫t "X√≥a th√¥ng tin" v√† khi modal ·∫©n
            function initResetHandlers() {
                const clearBtn = document.getElementById("clearBtn");
                if (clearBtn) {
                    clearBtn.addEventListener("click", () => {
                        console.log("Clear button clicked.");
                        resetUserForm();
                    });
                } else {
                    console.error("Kh√¥ng t√¨m th·∫•y n√∫t 'clearBtn'.");
                }

                const userModalEl = document.getElementById("userModal");
                if (userModalEl) {
                    userModalEl.addEventListener("hidden.bs.modal", () => {
                        console.log("Modal hidden event triggered.");
                        resetUserForm();
                    });
                } else {
                    console.error("Kh√¥ng t√¨m th·∫•y modal v·ªõi id 'userModal'.");
                }
            }

            // H√†m kh·ªüi t·∫°o s·ª± ki·ªán cho n√∫t "L∆∞u" ƒë·ªÉ g·ª≠i d·ªØ li·ªáu ng∆∞·ªùi d√πng
            function initSaveUserHandler() {
                const saveUserBtn = document.getElementById("saveUser");
                if (!saveUserBtn) {
                    console.error("Kh√¥ng t√¨m th·∫•y n√∫t 'saveUser'.");
                    return;
                }
                saveUserBtn.addEventListener("click", () => {
                    // L·∫•y d·ªØ li·ªáu t·ª´ c√°c tr∆∞·ªùng input
                    const maNguoiDung = document.getElementById("maNguoiDung").value.trim();
                    const taiKhoan = document.getElementById("taiKhoan").value.trim();
                    const matKhau = document.getElementById("matKhau").value.trim();
                    const hoTen = document.getElementById("hoTen").value.trim();
                    const tuoi = document.getElementById("tuoi").value.trim();
                    const email = document.getElementById("email").value.trim();
                    const soDienThoai = document.getElementById("soDienThoai").value.trim();
                    const diaChi = document.getElementById("diaChi").value.trim();

                    // Ki·ªÉm tra xem t·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn hay ch∆∞a
                    if (!maNguoiDung || !taiKhoan || !matKhau || !hoTen ||
                        !tuoi || !email || !soDienThoai || !diaChi) {
                        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                        return;
                    }

                    const userData = {
                        maNguoiDung,
                        taiKhoan,
                        matKhau,
                        hoTen,
                        tuoi,
                        email,
                        soDienThoai,
                        diaChi
                    };

                    // G·ª≠i d·ªØ li·ªáu ƒë·∫øn server b·∫±ng fetch API
                    fetch("themnguoidung.php", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(userData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.success); // Th√¥ng b√°o th√†nh c√¥ng
                                location.reload();    // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi d√πng
                            } else {
                                alert(data.error);    // Hi·ªÉn th·ªã l·ªói t·ª´ server
                            }
                        })
                        .catch(error => console.error("L·ªói khi g·ª≠i d·ªØ li·ªáu:", error));
                });
            }

            // H√†m kh·ªüi t·∫°o to√†n b·ªô c√°c event handler li√™n quan ƒë·∫øn th√™m ng∆∞·ªùi d√πng
            function initAddUserHandlers() {
                initResetHandlers();
                initSaveUserHandler();
            }

            // Expose c√°c h√†m n·∫øu c·∫ßn s·ª≠ d·ª•ng t·ª´ c√°c file JS kh√°c
            window.resetUserForm = resetUserForm;
            window.initAddUserHandlers = initAddUserHandlers;

            // G·ªçi h√†m kh·ªüi t·∫°o khi DOM ƒë√£ s·∫µn s√†ng
            initAddUserHandlers();
        });

        /*T√¨m ki·∫øm ng∆∞·ªùi d√πng*/
        document.addEventListener("DOMContentLoaded", function () {
            const searchUserButton = document.getElementById("searchUserButton");
            const clearSearchButton = document.getElementById("clearSearchButton");
            const searchInput = document.getElementById("searchMaNguoiDung");
            const searchResult = document.getElementById("searchResult");

            // S·ª± ki·ªán cho n√∫t T√¨m ki·∫øm
            searchUserButton.addEventListener("click", function () {
                const maNguoiDung = searchInput.value.trim();

                if (!maNguoiDung) {
                    alert("Vui l√≤ng nh·∫≠p m√£ ng∆∞·ªùi d√πng!");
                    return;
                }

                fetch("timkiemnguoidung.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ maNguoiDung })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success || !data.user) {
                            searchResult.innerHTML = `<p class="text-danger">${data.error || "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng!"}</p>`;
                        } else {
                            const user = data.user;
                            searchResult.innerHTML = `
            <table class="table table-bordered mt-3">
              <tr><th>M√£ Ng∆∞·ªùi D√πng</th><td>${user.ma_nguoi_dung || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
              <tr><th>T√†i Kho·∫£n</th><td>${user.tai_khoan || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
              <tr><th>M·∫≠t kh·∫©u</th><td>${user.mat_khau || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
              <tr><th>H·ªç T√™n</th><td>${user.ho_ten || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
              <tr><th>Tu·ªïi</th><td>${user.tuoi || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
              <tr><th>Email</th><td>${user.email || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
              <tr><th>SƒêT</th><td>${user.so_dien_thoai || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
              <tr><th>ƒê·ªãa Ch·ªâ</th><td>${user.dia_chi || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</td></tr>
            </table>
          `;
                        }
                    })
                    .catch(error => console.error("L·ªói khi t√¨m ki·∫øm ng∆∞·ªùi d√πng:", error));
            });

            // S·ª± ki·ªán cho n√∫t X√≥a th√¥ng tin (Clear)
            clearSearchButton.addEventListener("click", function () {
                searchInput.value = "";
                searchResult.innerHTML = "";
                console.log("Th√¥ng tin t√¨m ki·∫øm ƒë√£ ƒë∆∞·ª£c x√≥a.");
            });
        });





        // H√†m t·∫£i d·ªØ li·ªáu t·ª´ PHP v√† render v√†o b·∫£ng
        function fetchUserData(userTableBody) {
            fetch("quanlynguoidung.php")
                .then((response) => response.json())
                .then((users) => {
                    console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", users);

                    if (!Array.isArray(users)) {
                        console.error("L·ªói: D·ªØ li·ªáu kh√¥ng ph·∫£i m·∫£ng", users);
                        return;
                    }

                    userTableBody.innerHTML = ""; // X√≥a n·ªôi dung c≈©

                    users.forEach((user) => {
                        const row = `<tr>
                    <td>${user.ma_nguoi_dung}</td>
                    <td>${user.tai_khoan}</td>
                    <td>${user.mat_khau}</td>
                    <td>${user.ho_ten}</td>
                    <td>${user.tuoi}</td>
                    <td>${user.email}</td>
                    <td>${user.so_dien_thoai}</td>
                    <td>${user.dia_chi}</td>
                    <td style="background: #76b5c5">
                        <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" 
                            data-bs-target="#editUserModal" onclick="setEditUser(${user.ma_nguoi_dung})">
                            S·ª≠a
                        </button>
                       <button class="btn btn-danger btn-sm" 
        data-bs-toggle="modal" 
        data-bs-target="#deleteUserModal" 
        onclick="setDeleteUser('${user.ma_nguoi_dung}')" style="margin-right: 5px;">
    X√≥a
</button>
                    </td>
                </tr>`;
                        userTableBody.innerHTML += row;
                    });
                })
                .catch((error) => console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error));
        }

        function setEditUser(maNguoiDung) {
            fetch("quanlynguoidung.php")
                .then((response) => response.json())
                .then((users) => {
                    const user = users.find((user) => user.ma_nguoi_dung == maNguoiDung);
                    if (!user) {
                        console.error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi m√£:", maNguoiDung);
                        return;
                    }
                    document.getElementById("editMaNguoiDung").value = user.ma_nguoi_dung;
                    document.getElementById("editTaiKhoan").value = user.tai_khoan;
                    document.getElementById("editMatKhau").value = user.mat_khau;
                    document.getElementById("editHoTen").value = user.ho_ten;
                    document.getElementById("editTuoi").value = user.tuoi;
                    document.getElementById("editEmail").value = user.email;
                    document.getElementById("editSoDienThoai").value = user.so_dien_thoai;
                    document.getElementById("editDiaChi").value = user.dia_chi;
                })
                .catch((error) => console.error("L·ªói khi t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng:", error));
        }

        document.addEventListener("DOMContentLoaded", function () {
            function resetEditUserForm() {
                ["editMaNguoiDung", "editTaiKhoan", "editMatKhau", "editHoTen", "editTuoi", "editEmail", "editSoDienThoai", "editDiaChi"]
                    .forEach(id => document.getElementById(id).value = "");
            }

            document.getElementById("clearEditBtn")?.addEventListener("click", resetEditUserForm);
            document.getElementById("editUserModal")?.addEventListener("hidden.bs.modal", resetEditUserForm);

            document.getElementById("saveEditUser")?.addEventListener("click", function () {
                const maNguoiDung = document.getElementById("editMaNguoiDung").value.trim();
                const taiKhoan = document.getElementById("editTaiKhoan").value.trim();
                const matKhau = document.getElementById("editMatKhau").value.trim();
                const hoTen = document.getElementById("editHoTen").value.trim();
                const tuoi = document.getElementById("editTuoi").value.trim();
                const email = document.getElementById("editEmail").value.trim();
                const soDienThoai = document.getElementById("editSoDienThoai").value.trim();
                const diaChi = document.getElementById("editDiaChi").value.trim();

                if (!taiKhoan || !matKhau || !hoTen || !tuoi || !email || !soDienThoai || !diaChi) {
                    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    return;
                }

                fetch("kiemtra_id.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ maNguoiDung })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists && data.maNguoiDung !== maNguoiDung) {
                            alert("M√£ ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!");
                        } else {
                            updateUser({ maNguoiDung, taiKhoan, matKhau, hoTen, tuoi, email, soDienThoai, diaChi });
                        }
                    })
                    .catch(error => console.error("L·ªói ki·ªÉm tra ID:", error));
            });
        });

        function updateUser(editData) {
            fetch("suanguoidung.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(editData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                        location.reload();
                    } else {
                        alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i! " + (data.error || ""));
                    }
                })
                .catch(error => console.error("L·ªói khi c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng:", error));
        }




        /*X√≥a ng∆∞·ªùi d√πng*/
        document.addEventListener("DOMContentLoaded", function () {
            function setDeleteUser(maNguoiDung) {
                console.log("Ng∆∞·ªùi d√πng c·∫ßn x√≥a:", maNguoiDung);

                // Ki·ªÉm tra ph·∫ßn t·ª≠ input ·∫©n
                const deleteInput = document.getElementById("deleteMaNguoiDung");
                if (deleteInput) {
                    deleteInput.value = maNguoiDung;
                } else {
                    console.error("Kh√¥ng t√¨m th·∫•y input ·∫©n #deleteMaNguoiDung.");
                }
            }

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n "X√°c nh·∫≠n x√≥a"
            document.getElementById("confirmDeleteUser").addEventListener("click", function () {
                const deleteInput = document.getElementById("deleteMaNguoiDung");
                const maNguoiDung = deleteInput ? deleteInput.value.trim() : "";

                if (!maNguoiDung) {
                    alert("L·ªói: Kh√¥ng t√¨m th·∫•y m√£ ng∆∞·ªùi d√πng c·∫ßn x√≥a!");
                    return;
                }

                if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?")) {
                    return;
                }

                fetch("xoanguoidung.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ maNguoiDung })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("X√≥a th√†nh c√¥ng!");
                            location.reload();
                        } else {
                            alert("L·ªói: " + data.error);
                        }
                    })
                    .catch(error => console.error("L·ªói khi x√≥a ng∆∞·ªùi d√πng:", error));
            });

            // ƒê∆∞a setDeleteUser v√†o ph·∫°m vi to√†n c·ª•c ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c t·ª´ HTML
            window.setDeleteUser = setDeleteUser;
        });


        // Ch·ªù DOM ƒë∆∞·ª£c t·∫£i xong
        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOM ƒë√£ ƒë∆∞·ª£c load, JS ch·∫°y");

            // G·∫Øn s·ª± ki·ªán submit cho form t√¨m ki·∫øm
            const searchForm = document.getElementById("searchForm");
            if (searchForm) {
                searchForm.addEventListener("submit", function (event) {
                    event.preventDefault(); // NgƒÉn reload trang
                    fetchFilteredUsers();
                });
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y form v·ªõi id 'searchForm'");
            }
        });

        //Xu·∫•t Excel
        async function exportToExcel() {
            let fileName = prompt("Nh·∫≠p t√™n file (kh√¥ng c·∫ßn .xlsx):", "User_List");
            if (!fileName) return; // N·∫øu ng∆∞·ªùi d√πng nh·∫•n h·ªßy

            let table = document.querySelector("table");

            // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng, lo·∫°i b·ªè c·ªôt cu·ªëi c√πng (H√†nh ƒë·ªông)
            let data = [];
            let rows = table.querySelectorAll("tr");

            rows.forEach((row, index) => {
                let rowData = [];
                let cells = row.querySelectorAll("th, td");

                cells.forEach((cell, i) => {
                    // Kh√¥ng th√™m c·ªôt cu·ªëi c√πng (H√†nh ƒë·ªông: S·ª≠a/X√≥a)
                    if (i < cells.length - 1) {
                        rowData.push(cell.innerText);
                    }
                });

                data.push(rowData);
            });

            // T·∫°o Workbook & Worksheet
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Users");

            // üñ• N·∫øu tr√¨nh duy·ªát h·ªó tr·ª£ ch·ªçn n∆°i l∆∞u file
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: `${fileName}.xlsx`,
                        types: [
                            {
                                description: "Excel File",
                                accept: { "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"] },
                            },
                        ],
                    });

                    const writable = await handle.createWritable();
                    const excelBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });
                    await writable.write(new Blob([excelBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }));
                    await writable.close();

                    alert("Xu·∫•t file th√†nh c√¥ng!");
                    return;
                } catch (err) {
                    console.error("L·ªói khi l∆∞u file:", err);
                }
            }

            // üåç N·∫øu tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£, t·ª± ƒë·ªông t·∫£i file
            XLSX.writeFile(wb, `${fileName}.xlsx`);
        }


        //Nh·∫≠p file Excel
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("excelFile").addEventListener("change", handleFile);
        });

        function importExcel() {
            document.getElementById('excelFile').click();
        }

        let isProcessing = false; // Bi·∫øn ki·ªÉm so√°t vi·ªác x·ª≠ l√Ω

        async function handleFile(event) {
            if (isProcessing) return; // N·∫øu ƒëang x·ª≠ l√Ω, kh√¥ng l√†m g√¨ c·∫£
            isProcessing = true; // ƒê√°nh d·∫•u ƒëang x·ª≠ l√Ω

            let file = event.target.files[0];
            if (!file) {
                isProcessing = false;
                return;
            }

            let reader = new FileReader();
            reader.readAsArrayBuffer(file);

            reader.onload = async function (e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, { type: "array" });

                let sheetName = workbook.SheetNames[0];
                let sheet = workbook.Sheets[sheetName];

                let jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (jsonData.length < 2) {
                    alert("File kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!");
                    isProcessing = false;
                    return;
                }

                let headers = jsonData[0];
                let dataRows = jsonData.slice(1);

                let expectedHeaders = ["ID", "T√†i Kho·∫£n", "M·∫≠t Kh·∫©u", "H·ªç T√™n", "Tu·ªïi", "Email", "SƒêT", "ƒê·ªãa Ch·ªâ"];
                if (!expectedHeaders.every((h, i) => headers[i] === h)) {
                    alert("File Excel kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng c·ªôt! H√£y ki·ªÉm tra l·∫°i.");
                    isProcessing = false;
                    return;
                }

                console.log("ƒêang l·∫•y danh s√°ch ID hi·ªán c√≥...");
                let existingIDs = await fetchExistingIDs();
                console.log("ID t·ª´ CSDL:", existingIDs);

                let newData = [];
                let duplicateIDs = [];

                dataRows.forEach(row => {
                    let id = row[0]?.toString().trim(); // Chuy·ªÉn ID v·ªÅ d·∫°ng chu·ªói
                    if (!id) return;

                    if (existingIDs.includes(id)) {
                        duplicateIDs.push(id);
                    } else {
                        newData.push({
                            ma_nguoi_dung: id,
                            tai_khoan: row[1]?.toString().trim(),
                            mat_khau: row[2]?.toString().trim(),
                            ho_ten: row[3]?.toString().trim(),
                            tuoi: parseInt(row[4]) || 0,
                            email: row[5]?.toString().trim(),
                            so_dien_thoai: row[6]?.toString().trim(),
                            dia_chi: row[7]?.toString().trim()
                        });
                    }
                });

                if (duplicateIDs.length > 0) {
                    alert(`C√°c ID sau ƒë√£ t·ªìn t·∫°i: ${duplicateIDs.join(", ")}. H√£y ki·ªÉm tra l·∫°i!`);
                    isProcessing = false;
                    return;
                }

                if (newData.length > 0) {
                    console.log("üìå ƒêang g·ª≠i d·ªØ li·ªáu l√™n server...");
                    await saveToDatabase(newData);
                } else {
                    alert("Kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi ƒë·ªÉ nh·∫≠p v√†o CSDL.");
                }

                isProcessing = false; // Ho√†n t·∫•t x·ª≠ l√Ω
            };

            reader.onerror = function (error) {
                console.error("L·ªói ƒë·ªçc file:", error);
                alert("Kh√¥ng th·ªÉ ƒë·ªçc file Excel.");
                isProcessing = false;
            };
        }

        async function saveToDatabase(data) {
            console.log("üìå D·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i (object):", data);
            console.log("üìå D·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i (JSON):", JSON.stringify({ users: data }));

            try {
                let response = await fetch("http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-nguoidung/import-users.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ users: data }) // ƒê·∫£m b·∫£o JSON h·ª£p l·ªá
                });

                let text = await response.text(); // ƒê·ªçc ph·∫£n h·ªìi d·∫°ng text
                console.log("üìå Response t·ª´ server (tr∆∞·ªõc khi parse JSON):", text);

                let result = JSON.parse(text); // N·∫øu l·ªói, nghƒ©a l√† text kh√¥ng ph·∫£i JSON
                if (result.status === "success") {
                    alert("Nh·∫≠p file Excel th√†nh c√¥ng!");
                    location.reload();
                } else {
                    alert(`L·ªói khi l∆∞u v√†o CSDL: ${result.message}`);
                }
            } catch (error) {
                console.error("L·ªói khi l∆∞u d·ªØ li·ªáu:", error);
                alert("Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu v√†o CSDL. Ki·ªÉm tra log console ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.");
            }
        }


        async function fetchExistingIDs() {
            try {
                let response = await fetch("http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-nguoidung/get-existing-ids.php");
                if (!response.ok) throw new Error(`L·ªói HTTP: ${response.status}`);

                let data = await response.json();
                console.log("Response t·ª´ server:", data);

                if (data.success && Array.isArray(data.ids)) {
                    return data.ids.map(id => id.toString().trim());
                } else {
                    console.warn("‚ö† D·ªØ li·ªáu ID kh√¥ng h·ª£p l·ªá, s·∫Ω s·ª≠ d·ª•ng danh s√°ch r·ªóng.");
                    return [];
                }
            } catch (error) {
                console.error("L·ªói l·∫•y danh s√°ch ID:", error);
                return []; // Kh√¥ng hi·ªÉn th·ªã alert n·ªØa, ch·ªâ log l·ªói
            }
        }


    </script>
</head>

<body>
    <!-- Header -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">

                <!-- Menu ch√≠nh -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 menu">
                    <li class="nav-item">
                        <a class="nav-link" href="https://short.com.vn/VSYd">Qu·∫£n l√Ω ng∆∞·ªùi
                            d√πng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-sach/quanlysach.html">Qu·∫£n
                            l√Ω s√°ch</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-tintuc/quanlytintuc.html">Qu·∫£n
                            l√Ω tin t·ª©c</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-chude/quanlychude.html">Qu·∫£n
                            l√Ω ch·ªß ƒë·ªÅ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Lienhe-hotro/lienhe_hotro.html">Li√™n
                            h·ªá h·ªó tr·ª£</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Thongke/thongke.html">Th·ªëng
                            k√™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/BaoCao/baocao.html">B√°o
                            c√°o</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            href="http://localhost/PHP-project/Web%20Th%c6%b0%20vi%e1%bb%87n/Quanly-all/Quanly-chude/logout.php">ƒêƒÉng
                            xu·∫•t</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <style>
            body {
                background-color: #873e23;
                /* M√†u n·ªÅn mong mu·ªën */
            }

            .table {
                background-color: white !important;
                /* Gi·ªØ m√†u tr·∫Øng cho b·∫£ng */
            }
        </style>
        <div class="container mt-5">
            <div class="container mt-4">
                <!-- C√°c n√∫t ch·ª©c nƒÉng -->
                <div class="mb-3 d-flex justify-content-start">
                    <h2 class="text-center" style="margin-right: 100px; color: white;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
                    <button class="btn btn-primary me-2" data-bs-toggle="modal"
                        data-bs-target="#userModal">Th√™m</button>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#searchUserModal">T√¨m
                        ki·∫øm</button>
                    <button class="btn btn-warning me-2" type="button" onclick="resetDisplay()">Reset</button>

                    <!-- Giao di·ªán -->
                    <form id="searchForm" class="d-flex search-form"
                        style="background-color: black; margin-right: 5px; padding: 10px;">
                        <select class="form-select me-2" id="filterType">
                            <option value="name">L·ªçc theo t√™n</option>
                            <option value="age">L·ªçc theo tu·ªïi</option>
                            <option value="address">L·ªçc theo ƒë·ªãa ch·ªâ</option>
                        </select>
                        <input id="searchInput" class="form-control me-2" type="text" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
                        <button class="btn btn-danger me-2" type="submit">L·ªçc</button>
                        <!--Th∆∞ vi·ªán cho nh·∫≠p xu·∫•t-->
                    </form>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
                    <button class="btn btn-info me-2" onclick="exportToExcel()">üì§ Xu·∫•t Excel</button>
                    <button class="btn btn-secondary me-2" onclick="importExcel()">üì• Nh·∫≠p Excel</button>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;"
                        onchange="handleFile(event)">
                </div>
            </div>
            <!-- B·∫£ng hi·ªÉn th·ªã k·∫øt qu·∫£ -->
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>T√†i Kho·∫£n</th>
                        <th>M·∫≠t Kh·∫©u</th>
                        <th>H·ªç T√™n</th>
                        <th>Tu·ªïi</th>
                        <th>Email</th>
                        <th>SƒêT</th>
                        <th>ƒê·ªãa Ch·ªâ</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="8">Nh·∫≠p t·ª´ kh√≥a v√† nh·∫•n "L·ªçc" ƒë·ªÉ t√¨m ki·∫øm.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Popup Form (Bootstrap Modal) Th√™m ng∆∞·ªùi d√πng-->
        <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">Th√™m Ng∆∞·ªùi D√πng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- C√°c tr∆∞·ªùng nh·∫≠p th√¥ng tin -->
                        <div class="mb-3">
                            <label for="maNguoiDung" class="form-label">M√£ ng∆∞·ªùi d√πng:</label>
                            <input type="text" id="maNguoiDung" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="taiKhoan" class="form-label">T√†i kho·∫£n:</label>
                            <input type="text" id="taiKhoan" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="matKhau" class="form-label">M·∫≠t kh·∫©u:</label>
                            <input type="password" id="matKhau" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="hoTen" class="form-label">H·ªç t√™n:</label>
                            <input type="text" id="hoTen" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="tuoi" class="form-label">Tu·ªïi:</label>
                            <input type="text" id="tuoi" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email:</label>
                            <input type="email" id="email" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="soDienThoai" class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
                            <input type="text" id="soDienThoai" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="diaChi" class="form-label">ƒê·ªãa ch·ªâ:</label>
                            <textarea id="diaChi" class="form-control"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <!-- N√∫t H·ªßy d√πng ƒë·ªÉ ƒë√≥ng modal (c≈©ng reset form th√¥ng qua s·ª± ki·ªán modal hide) -->
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                            id="cancelBtn">H·ªßy</button>
                        <!-- N√∫t X√≥a th√¥ng tin ƒë·ªÉ reset form ngay l·∫≠p t·ª©c -->
                        <button type="button" class="btn btn-warning" id="clearBtn">X√≥a th√¥ng tin</button>
                        <button type="button" class="btn btn-success" id="saveUser">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Popup Modal S·ª≠a Ng∆∞·ªùi D√πng -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editUserModalLabel">S·ª≠a Th√¥ng Tin Ng∆∞·ªùi D√πng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editUserForm">
                            <div class="mb-3">
                                <label for="editMaNguoiDung" class="form-label">M√£ Ng∆∞·ªùi D√πng:</label>
                                <input type="text" id="editMaNguoiDung" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="editTaiKhoan" class="form-label">T√†i Kho·∫£n:</label>
                                <input type="text" id="editTaiKhoan" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="editMatKhau" class="form-label">M·∫≠t Kh·∫©u:</label>
                                <input type="password" id="editMatKhau" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="editHoTen" class="form-label">H·ªç T√™n:</label>
                                <input type="text" id="editHoTen" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="editTuoi" class="form-label">Tu·ªïi:</label>
                                <input type="number" id="editTuoi" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Email:</label>
                                <input type="email" id="editEmail" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="editSoDienThoai" class="form-label">S·ªë ƒêi·ªán Tho·∫°i:</label>
                                <input type="text" id="editSoDienThoai" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="editDiaChi" class="form-label">ƒê·ªãa Ch·ªâ:</label>
                                <textarea id="editDiaChi" class="form-control"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <!-- N√∫t H·ªßy d√πng ƒë·ªÉ ƒë√≥ng modal (v√† reset form th√¥ng qua s·ª± ki·ªán modal hide) -->
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                            id="cancelEditBtn">H·ªßy</button>
                        <!-- N√∫t X√≥a th√¥ng tin ƒë·ªÉ reset form ngay l·∫≠p t·ª©c (s·ª≠ d·ª•ng id "clearEditBtn") -->
                        <button type="button" class="btn btn-warning" id="clearEditBtn">X√≥a th√¥ng tin</button>
                        <button type="button" class="btn btn-primary" id="saveEditUser">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal X√°c nh·∫≠n X√≥a -->
        <div class="modal fade" id="deleteUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?</p>
                        <input type="hidden" id="deleteMaNguoiDung">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button id="confirmDeleteUser" class="btn btn-danger">X√≥a</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup Modal T√¨m Ki·∫øm Ng∆∞·ªùi D√πng -->
        <div class="modal fade" id="searchUserModal" tabindex="-1" aria-labelledby="searchUserModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="searchUserModalLabel">T√¨m Ki·∫øm Ng∆∞·ªùi D√πng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="searchMaNguoiDung" class="form-label">Nh·∫≠p M√£ Ng∆∞·ªùi D√πng:</label>
                            <input type="text" id="searchMaNguoiDung" class="form-control">
                        </div>
                        <!-- N√∫t H·ªßy ƒë√≥ng modal -->
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <!-- N√∫t X√≥a th√¥ng tin ƒë·ªÉ reset tr∆∞·ªùng nh·∫≠p -->
                        <button type="button" class="btn btn-warning" id="clearSearchButton">X√≥a th√¥ng tin</button>
                        <button type="button" class="btn btn-primary" id="searchUserButton">T√¨m Ki·∫øm</button>
                        <hr>
                        <div id="searchResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>

</html>